<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="build-common" default="default">
    <import file="dependencies.xml"/>

    <target name="default" depends="os-app"/>

    <!-- ====== properties ========== -->

    <property name="classes"    value="${dependencies.basedir}/build/classes/${ant.project.name}"/>
    <property name="libs"       value="${dependencies.basedir}/build/libs"/>
    <property name="dist"       value="${dependencies.basedir}/build/dist/${ant.project.name}"/>
    <property name="module"     value="${dependencies.basedir}/modules/${ant.project.name}"/>
    <property name="resources"  value="${dependencies.basedir}/build/resources/${ant.project.name}"/>
    <property name="deploy"     value="${dependencies.basedir}/build/deploy/${ant.project.name}"/>

    <!-- ====== extra tasks ========== -->

    <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
        <pathelement location="${dependencies.basedir}/external/build/ant-contrib-1.0b3.jar"/>
      </classpath>
    </taskdef>

    <taskdef name="jarbundler"
             classpath="${dependencies.basedir}/external/build/jarbundler-2.0.0.jar"
             classname="net.sourceforge.jarbundler.JarBundler" />


    <!-- ====== targets ========== -->    

    <target name="clean">
        <delete dir="${dependencies.basedir}/build"/>
    </target>

    <target  name="prepare">
            <tstamp/>
        <mkdir dir="${classes}"/>
        <mkdir dir="${libs}"/>
        <mkdir dir="${dist}"/>
        <mkdir dir="${resources}"/>
        <mkdir dir="${deploy}"/>
    </target>


    <fileset id="internalsSet" dir="${libs}">
        <include name="*.jar"/>
    </fileset>
    <path id="jars">
        <fileset refid="internalsSet"/>
    </path>

    <!-- compile sources and copy pictures and xmsl -->
    <target name="compile" depends="prepare">
        <javac srcdir="${module}/src" destdir="${classes}">
            <classpath refid="jars"></classpath>
        </javac>

        <copy todir="${classes}" flatten="no">
            <fileset dir="${module}/src" includes="**/*.xml"/>
        </copy>


    </target>

    <!-- construct the manifest -->
    <target name="create-manifest" depends="prepare">
        <pathconvert property="jars-var" pathsep=" " refid="jars">
            <map from="${dependencies.basedir}/libs/" to=""/>
        </pathconvert>

        <manifest file="${resources}/manifest.mf" mode="replace">
            <attribute name="Built-By" value="${user.name}"/>
            <attribute name="Created-By" value="Stephan Pfab"/>
            <attribute name="Class-Path" value="${jars-var}"/>
        </manifest>
        <if>
            <isset property="main"/>
            <then>
                <manifest file="${resources}/manifest.mf" mode="update">
                    <attribute name="Main-Class" value="${main}"/>
                </manifest>
            </then>
        </if>
    </target>


    <target name="create-jar" depends="compile,create-manifest">
        <echo message="${ant.project.name} - build-common.dist"/>
        <jar jarfile="${libs}/openCage-${ant.project.name}-${version}.jar"
             manifest="${resources}/manifest.mf">
            <fileset dir="${classes}" excludes="**/*test*"/>
        </jar>
    </target>

    <target name="os-app" depends="dist" > <!-- ,jni"> -->
        <if >
           <isset property="app-name"/>
            <then>
           <jarbundler dir="${deploy}"
                       verbose="true"
                       name="${app-name}"
                       shortname="${app-name}"
                       stubfile="${app-name}"
                       signature="${app-signature}"
                       mainclass="${main}"
                       jvmversion="1.6+"
                       version="${version}"
                       infostring="${app-name}, MPL1.1"
                       build="${buildnumber}"
                       bundleid="${bundleid}"
                   >
               <!--helpbookfolder="HelpBook"-->
               <!--helpbookname="Stroy Help"-->
               <!--icon="${resources}/stroy.icns"-->
               <jarfileset refid="internalsSet"/>
               <!--<jarfilelist dir="${lib}" files="stroy2ui.jar" />-->

               <!-- Copy the HelpBook JNI library  -->
               <!--<javafilelist dir="${build-objc}" files="libHelpBookJNI.jnilib"/>-->

               <javaproperty name="apple.laf.useScreenMenuBar" value="true"/>
               <javaproperty name="com.apple.macos.useScreenMenuBar" value="true"/>

               <!--<HelpBook locale="English">-->
                   <!--<fileset dir="${resources}/HelpBook/English" />-->
                   <!--<fileset dir="${resources}/HelpBook/common" />-->
               <!--</HelpBook>-->

           </jarbundler>
            </then>
           </if>
       </target>


    <target name="dist" depends="create-jar" >
        <copy todir="${dist}">
            <fileset refid="internalsSet"/>
        </copy>
    </target>

    <target name="dist.dependencies">
        <antcall target="depend.${ant.project.name}"/>
    </target>
</project>
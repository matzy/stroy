<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="build-common" default="default">
    <import file="dependencies.xml"/>

    <target name="default" depends="dist"/>


    <property name="classes"    value="${dependencies.basedir}/classes/${ant.project.name}"/>
    <property name="libs"       value="${dependencies.basedir}/libs"/>
    <property name="dist"       value="${dependencies.basedir}/dist/${ant.project.name}"/>
    <property name="module"     value="${dependencies.basedir}/modules/${ant.project.name}"/>
    <property name="resources"  value="${dependencies.basedir}/resources/${ant.project.name}"/>

    <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
        <pathelement location="${dependencies.basedir}/external/build/ant-contrib-1.0b3.jar"/>
      </classpath>
    </taskdef>

    <target name="clean">
        <delete dir="${dependencies.basedir}/classes"/>
        <delete dir="${dependencies.basedir}/libs"/>
        <delete dir="${dependencies.basedir}/dist"/>
        <delete dir="${dependencies.basedir}/resources"/>
    </target>

    <target  name="prepare">
            <tstamp/>
        <mkdir dir="${classes}"/>
        <mkdir dir="${libs}"/>
        <mkdir dir="${dist}"/>
        <mkdir dir="${resources}"/>
    </target>


    <fileset id="externalsSet" dir="${dependencies.basedir}/external/production">
        <include name="*.jar"/>
    </fileset>
    <fileset id="internalsSet" dir="${libs}">
        <include name="*.jar"/>
    </fileset>
    <path id="jars">
        <fileset refid="externalsSet"/>
        <fileset refid="internalsSet"/>
    </path>


    <!-- compile sources -->
    <target name="compile" depends="prepare">
        <javac srcdir="${module}/src" destdir="${classes}">
            <classpath refid="jars"></classpath>
        </javac>

    </target>

    <!--<target name="copy-resources" depends="prepare">-->
        <!--<copy file="${module}/manifest.mf" todir="${resources}"/>-->
    <!--</target>-->

    <!-- create manifest from some module specific properties-->
    <target name="create-manifest" depends="prepare">
        <pathconvert property="jars-var" pathsep=" " refid="internalsSet">
            <map from="${dependencies.basedir}/libs/" to=""/>
        </pathconvert>
        <echo message="Manifest-Version: 1.0 ${line.separator}Created-By: Stephan Pfab${line.separator}Class-Path: ${jars-var} ${jars-external} ${line.separator}"
               file="${resources}/manifest.mf"
               append="no"/>
        <if>
            <isset property="main"/>
             <then>
                 <echo message="Main-Class: ${main}${line.separator}"
                        file="${resources}/manifest.mf"
                        append="yes"/>
             </then>
             <else>
               <echo message="property main is not set" />
             </else>
        </if>

    </target>



    <target name="create-jar" depends="compile,create-manifest">
        <echo message="${ant.project.name} - build-common.dist"/>
        <jar jarfile="${libs}/openCage-${ant.project.name}-${version}.jar"
             manifest="${resources}/manifest.mf">
            <fileset dir="${classes}" excludes="**/*test*"/>
        </jar>
    </target>

    <target name="dist" depends="create-jar" >
        <copy todir="${dist}">
            <fileset dir="${libs}"/>
            <fileset refid="externalsSet"/>
        </copy>

    </target>

    <target name="dist.dependencies">
        <antcall target="depend.${ant.project.name}"/>
    </target>
</project>